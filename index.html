<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXA.SEAL V2.0 - لوحة التحكم السيادية</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #e5e7eb; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .nexa-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body class="p-4 md:p-8">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-black tracking-tighter nexa-gradient bg-clip-text text-transparent italic">NEXA.SEAL V2.0</h1>
        <p class="text-gray-400 text-sm mt-2">بروتوكول السيادة المحلية للأصول الرقمية</p>
    </header>

    <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <div class="md:col-span-1 space-y-6">
            <div class="glass-card p-6 rounded-3xl text-center">
                <button id="connectBtn" class="w-full py-3 rounded-2xl font-bold bg-indigo-600 hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-500/20">
                    ربط محفظة MetaMask
                </button>
                <p id="walletAddress" class="mt-4 text-[10px] text-gray-500 truncate">المحفظة غير مرتبطة</p>
            </div>

            <div class="glass-card p-6 rounded-3xl">
                <h3 class="font-bold text-sm mb-4 border-b border-white/10 pb-2 text-indigo-400">إحصائيات السيادة</h3>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-gray-400">إجمالي الأختام:</span>
                    <span id="sealCount" class="text-lg font-mono font-bold text-white">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-400">حالة الشبكة:</span>
                    <span class="text-[10px] text-green-400"><span class="status-dot bg-green-400 animate-pulse ml-1"></span> متصل</span>
                </div>
            </div>
        </div>

        <div class="md:col-span-2 space-y-6">
            <div class="glass-card p-8 rounded-3xl border-l-4 border-indigo-500">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <span class="ml-2 text-indigo-400 italic">01.</span> الختم الجزيئي
                </h2>
                <input type="file" id="fileInput" class="hidden">
                <label for="fileInput" class="block w-full p-10 border-2 border-dashed border-white/10 rounded-2xl text-center cursor-pointer hover:border-indigo-500 transition-colors">
                    <div id="fileStatus" class="text-gray-400 italic text-sm">ارفع ملفك لزرع هويتك المشفرة</div>
                </label>
                <button id="sealBtn" class="w-full mt-6 py-4 rounded-2xl font-black nexa-gradient text-white shadow-xl opacity-50 cursor-not-allowed" disabled>
                    بـدء عـمـلـيـة الـخـتـم
                </button>
                <a id="downloadLink" class="hidden block mt-4 text-center text-cyan-400 text-sm font-bold underline decoration-dotted">تحميل النسخة السيادية المختومة</a>
            </div>

            <div class="glass-card p-8 rounded-3xl">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <span class="ml-2 text-pink-400 italic">02.</span> سجل الأصول المحمية
                </h2>
                <div id="historyList" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                    <p class="text-center text-gray-600 italic text-xs py-10">لا توجد أختام مسجلة حالياً</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let web3;
        let account;
        let sealCounter = 0;

        const connectBtn = document.getElementById('connectBtn');
        const walletAddress = document.getElementById('walletAddress');
        const fileInput = document.getElementById('fileInput');
        const sealBtn = document.getElementById('sealBtn');
        const historyList = document.getElementById('historyList');

        connectBtn.onclick = async () => {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                account = accounts[0];
                walletAddress.innerText = `سيادة الحساب: ${account}`;
                connectBtn.innerText = "متصل بنجاح";
                connectBtn.classList.replace('bg-indigo-600', 'bg-green-600');
                sealBtn.disabled = false;
                sealBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                alert("يرجى فتح الموقع من داخل متصفح MetaMask");
            }
        };

        fileInput.onchange = (e) => {
            const fileName = e.target.files[0].name;
            document.getElementById('fileStatus').innerText = `تم اختيار: ${fileName}`;
            document.getElementById('fileStatus').classList.add('text-indigo-400');
        };

        sealBtn.onclick = async () => {
            const message = `NEXA_SEAL_PROTOCOL_V2\nOwner: ${account}\nTimestamp: ${Date.now()}`;
            try {
                const signature = await web3.eth.personal.sign(message, account);
                
                // إضافة للسجل
                sealCounter++;
                document.getElementById('sealCount').innerText = sealCounter;
                
                const entry = document.createElement('div');
                entry.className = "flex justify-between items-center p-3 rounded-xl bg-white/5 border border-white/5 text-[10px]";
                entry.innerHTML = `
                    <span class="text-gray-300 font-mono italic">الملف #${sealCounter}</span>
                    <span class="text-indigo-300 truncate w-32 ml-2">${signature}</span>
                    <span class="text-green-500 font-bold">مختوم ✅</span>
                `;
                
                if (sealCounter === 1) historyList.innerHTML = '';
                historyList.prepend(entry);

                // تفعيل التحميل الصوري (تجريبي)
                const downloadLink = document.getElementById('downloadLink');
                downloadLink.classList.remove('hidden');
                downloadLink.href = URL.createObjectURL(fileInput.files[0]);
                downloadLink.download = `SEALED_${fileInput.files[0].name}`;
                
                alert("تم توليد الختم بنجاح وتسجيله في لوحة التحكم!");
            } catch (error) {
                console.error(error);
            }
        };
    </script>
</body>
</html>
